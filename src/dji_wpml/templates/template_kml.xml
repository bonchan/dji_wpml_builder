<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:wpml="http://www.dji.com/wpmz/1.0.6">
  <Document>
    <wpml:author>{{ author }}</wpml:author>
    <wpml:createTime>{{ create_time }}</wpml:createTime>
    <wpml:updateTime>{{ update_time }}</wpml:updateTime>
    <wpml:missionConfig>
      <wpml:flyToWaylineMode>{{ mission_config.fly_to_wayline_mode.value }}</wpml:flyToWaylineMode>
      <wpml:finishAction>{{ mission_config.finish_action.value }}</wpml:finishAction>
      <wpml:exitOnRCLost>{{ mission_config.exit_on_rc_lost.value }}</wpml:exitOnRCLost>
      <wpml:executeRCLostAction>{{ mission_config.execute_rc_lost_action.value }}</wpml:executeRCLostAction>
      <wpml:takeOffSecurityHeight>{{ mission_config.take_off_security_height }}</wpml:takeOffSecurityHeight>
      <wpml:globalTransitionalSpeed>{{ mission_config.global_transitional_speed }}</wpml:globalTransitionalSpeed>
      <wpml:globalRTHHeight>{{ mission_config.global_rth_height }}</wpml:globalRTHHeight>
      
      {% if mission_config.take_off_ref_point %}
      <wpml:takeOffRefPoint>{{ mission_config.take_off_ref_point | join(',') }}</wpml:takeOffRefPoint>
      {% endif %}
      
      {% if mission_config.take_off_ref_point_agl_height is not none %}
      <wpml:takeOffRefPointAGLHeight>{{ mission_config.take_off_ref_point_agl_height }}</wpml:takeOffRefPointAGLHeight>
      {% endif %}
      
      <wpml:droneInfo>
        <wpml:droneEnumValue>{{ mission_config.drone_info.drone_enum_value }}</wpml:droneEnumValue>
        <wpml:droneSubEnumValue>{{ mission_config.drone_info.drone_sub_enum_value }}</wpml:droneSubEnumValue>
      </wpml:droneInfo>
      
      <wpml:payloadInfo>
        <wpml:payloadEnumValue>{{ mission_config.payload_info.payload_enum_value }}</wpml:payloadEnumValue>
        <!-- <wpml:payloadSubEnumValue></wpml:payloadSubEnumValue> -->
        <wpml:payloadPositionIndex>{{ mission_config.payload_info.payload_position_index }}</wpml:payloadPositionIndex>
      </wpml:payloadInfo>
    </wpml:missionConfig>
    <Folder>
      <wpml:templateType>waypoint</wpml:templateType>
      <wpml:templateId>0</wpml:templateId>
      <wpml:waylineCoordinateSysParam>
        <wpml:coordinateMode>WGS84</wpml:coordinateMode>
        <wpml:heightMode>{{ template_info.wayline_coordinate_sys_param.height_mode.value }}</wpml:heightMode>
      </wpml:waylineCoordinateSysParam>
      <wpml:autoFlightSpeed>{{ template_info.auto_flight_speed }}</wpml:autoFlightSpeed>
      
      {% for wp in template_info.waypoint_info %}
      <Placemark>
        <Point>
          <coordinates>{{ wp.longitude }},{{ wp.latitude }}</coordinates>
        </Point>
        <wpml:index>{{ wp.index }}</wpml:index>
        <wpml:ellipsoidHeight>{{ wp.ellipsoid_height }}</wpml:ellipsoidHeight>
        <wpml:height>{{ wp.height }}</wpml:height>
        <wpml:waypointSpeed>{{ wp.waypoint_speed }}</wpml:waypointSpeed>
        <wpml:waypointTurnParam>
          <wpml:waypointTurnMode>toPointAndStopWithDiscontinuityCurvature</wpml:waypointTurnMode>
          <wpml:waypointTurnDampingDist>{{ wp.waypoint_turn_param }}</wpml:waypointTurnDampingDist>
        </wpml:waypointTurnParam>
        <wpml:useGlobalHeight>0</wpml:useGlobalHeight>
        <wpml:useGlobalSpeed>1</wpml:useGlobalSpeed>
        <wpml:useGlobalHeadingParam>1</wpml:useGlobalHeadingParam>
        <wpml:useGlobalTurnParam>1</wpml:useGlobalTurnParam>
        <wpml:useStraightLine>{{ 1 if wp.use_straight_line else 0 }}</wpml:useStraightLine>
        
        {% if wp.action_group %}
        <wpml:actionGroup>
            <wpml:actionGroupId>{{ wp.action_group.action_group_id }}</wpml:actionGroupId>
            <wpml:actionGroupStartIndex>{{ wp.action_group.action_group_start_index }}</wpml:actionGroupStartIndex>
            <wpml:actionGroupEndIndex>{{ wp.action_group.action_group_end_index }}</wpml:actionGroupEndIndex>
            <wpml:actionGroupMode>{{ wp.action_group.action_group_mode.value }}</wpml:actionGroupMode>
            <wpml:actionTrigger>
              <wpml:actionTriggerType>{{ wp.action_group.action_trigger.action_trigger_type.value }}</wpml:actionTriggerType>
            </wpml:actionTrigger>
            
            {% for action in wp.action_group.actions %}
            <wpml:action>
              <wpml:actionId>{{ action.action_id }}</wpml:actionId>
              <wpml:actionActuatorFunc>{{ action.action_actuator_func.value }}</wpml:actionActuatorFunc>
              <wpml:actionActuatorFuncParam>
                
                {% if action.action_actuator_func.value == "orientedShoot" %}
                <wpml:gimbalPitchRotateAngle>{{ action.action_actuator_func_param.gimbal_pitch_rotate_angle }}</wpml:gimbalPitchRotateAngle>
                <wpml:actionUUID>{{ action.action_actuator_func_param.action_uuid }}</wpml:actionUUID>
                <wpml:orientedCameraType>{{ action.action_actuator_func_param.oriented_camera_type }}</wpml:orientedCameraType>
                <wpml:orientedPhotoMode>{{ action.action_actuator_func_param.oriented_photo_mode }}</wpml:orientedPhotoMode>
                <wpml:imageWidth>{{ action.action_actuator_func_param.image_width }}</wpml:imageWidth>
                <wpml:imageHeight>{{ action.action_actuator_func_param.image_height }}</wpml:imageHeight>
                
                {% elif action.action_actuator_func.value == "gimbalRotate" %}
                <wpml:gimbalRotateMode>{{ action.action_actuator_func_param.gimbal_rotate_mode }}</wpml:gimbalRotateMode>
                <wpml:gimbalPitchRotateEnable>{{ action.action_actuator_func_param.gimbal_pitch_rotate_enable }}</wpml:gimbalPitchRotateEnable>
                <wpml:gimbalPitchRotateAngle>{{ action.action_actuator_func_param.gimbal_pitch_rotate_angle }}</wpml:gimbalPitchRotateAngle>
                
                {% elif action.action_actuator_func.value == "rotateYaw" %}
                <wpml:aircraftHeading>{{ action.action_actuator_func_param.aircraft_heading }}</wpml:aircraftHeading>
                <wpml:aircraftPathMode>{{ action.action_actuator_func_param.aircraft_path_mode }}</wpml:aircraftPathMode>
                
                {% elif action.action_actuator_func.value == "takePhoto" %}
                <wpml:payloadPositionIndex>{{ action.action_actuator_func_param.payload_position_index }}</wpml:payloadPositionIndex>
                <wpml:fileSuffix>{{ action.action_actuator_func_param.file_suffix }}</wpml:fileSuffix>
                <wpml:payloadLensIndex>{{ action.action_actuator_func_param.payload_lens_index }}</wpml:payloadLensIndex>
                <wpml:useGlobalPayloadLensIndex>{{ action.action_actuator_func_param.use_global_payload_lens_index }}</wpml:useGlobalPayloadLensIndex>

                {% elif action.action_actuator_func.value == "zoom" %}
                <wpml:payloadPositionIndex>{{ action.action_actuator_func_param.payload_position_index }}</wpml:payloadPositionIndex>
                <wpml:focalLength>{{ action.action_actuator_func_param.focal_length }}</wpml:focalLength>
                
                {% endif %}
                
              </wpml:actionActuatorFuncParam>
            </wpml:action>
            {% endfor %}
            
        </wpml:actionGroup>
        {% endif %}
        
        <wpml:isRisky>{{ 1 if wp.is_risky else 0 }}</wpml:isRisky>
      </Placemark>
      {% endfor %}
      
      <wpml:payloadParam>
        <wpml:payloadPositionIndex>0</wpml:payloadPositionIndex>
        <wpml:imageFormat>visable,ir</wpml:imageFormat>
      </wpml:payloadParam>
    </Folder>
  </Document>
</kml>